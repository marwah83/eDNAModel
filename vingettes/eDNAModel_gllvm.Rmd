---
title: "eDNAModel: gllvm"
author: "Marwah Soliman, Bert van der Veen"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    number_sections: true
vignette: >
  %\VignetteIndexEntry{eDNAModel: gllvm}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load-packages, message=FALSE, warning=FALSE}
library(phyloseq)
library(Matrix)
library(eDNAModel)
library(dplyr)
library(tidyr)
library(ggplot2)
library(pheatmap)
library(tibble)
library(gllvm)
library(glmmTMB)
library(reshape2)
```

# 1. Introduction

This vignette demonstrates the updated occupancy–detection model workflow using the `eDNAModel` package and `phyloseq` data objects. The workflow includes fitting binomial and Poisson mixed-effects models across iterations, visualizing occupancy and detection probabilities, using gllvm for occupancy model.

---

# 2. Load and Subset Data
```{r load-data}
physeq_new=readRDS("~/Downloads/BGE_Port_sampling.rds")
physeq_one=physeq_new$`Marine Invasive species Trondheim`
```

# 3. Fit the Occupancy–Detection Model

```{r fit-model, echo=FALSE}
out <- FitModel_gllvm(
       phyloseq = physeq_one,
       site_col = "Name",
       abundance_rhs = (1|Samplingmonth/OTU)+(1|OTU),
       occupancy_covars = "Samplingmonth",
       abundance_family = "poisson",
       n_iter = 50,
       burn_in = 10
   )

```
# 4. Visualization

## 4.1 Occupancy Probability Caterpillar Plot

```{r plot-detect, fig.width=10, fig.height=9}

psi_otu_summary <- out$summary %>%
     group_by(OTU) %>%
     summarise(
         psi_mean = mean(psi_mean, na.rm = TRUE),
         psi_lwr = mean(psi_lwr, na.rm = TRUE),
         psi_upr = mean(psi_upr, na.rm = TRUE),
         .groups = "drop"
     ) %>%
     arrange(psi_mean) %>%
     mutate(OTU = factor(OTU, levels = unique(OTU)))
 
 # Plot
 ggplot(psi_otu_summary, aes(x = psi_mean, y = OTU)) +
     geom_point(color = "darkgreen") +
     geom_errorbarh(aes(xmin = psi_lwr, xmax = psi_upr), height = 0.2) +
     labs(
         title = "Caterpillar Plot: Occupancy Probability by OTU",
         x = "Occupancy Probability (ψ)",
         y = "OTU"
     ) +
     theme_minimal() +
     theme(
         axis.text.y = element_text(size = 8),
         plot.title = element_text(hjust = 0.5)
     )

```
## 4.2 Detection Probability Caterpillar Plot

```{r plot-occupancy,fig.width=10, fig.height=9}

 p_detect_otu_summary <- out$summary %>%
     group_by(OTU) %>%
     summarise(
         p_detect_mean = mean(p_detect_mean, na.rm = TRUE),
         p_detect_lwr = mean(p_detect_lwr, na.rm = TRUE),
         p_detect_upr = mean(p_detect_upr, na.rm = TRUE),
         .groups = "drop"
     ) %>%
     arrange(p_detect_mean) %>%
     mutate(OTU = factor(OTU, levels = unique(OTU)))
 
 # Plot
 ggplot(p_detect_otu_summary, aes(x = p_detect_mean, y = OTU)) +
     geom_point(color = "steelblue") +
     geom_errorbarh(aes(xmin = p_detect_lwr, xmax = p_detect_upr), height = 0.2) +
     labs(
         title = "Caterpillar Plot: Detection Probability by OTU",
         x = "Detection Probability (p)",
         y = "OTU"
     ) +
     theme_minimal() +
     theme(
         axis.text.y = element_text(size = 8),
         plot.title = element_text(hjust = 0.5)
     )
```
