---
title: "eDNAModel: Updated Workflow with Phyloseq"
author: "Marwah Soliman, Bert van der Veen"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    number_sections: true
vignette: >
  %\VignetteIndexEntry{eDNAModel: Updated Workflow with Phyloseq}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load-packages, message=FALSE, warning=FALSE}
library(phyloseq)
library(Matrix)
library(eDNAModel)
library(dplyr)
library(tidyr)
library(ggplot2)
library(pheatmap)
library(tibble)
```

# 1. Introduction

This vignette demonstrates the updated occupancy–detection model workflow using the `eDNAModel` package and `phyloseq` data objects. The workflow includes fitting binomial and Poisson mixed-effects models across iterations, visualizing occupancy and detection probabilities, and comparing models using AIC/BIC.

---

# 2. Load and Subset Data

```{r load-data}
physeq_path <- system.file("extdata", "longdataexample.RDS", package = "eDNAModel")
physeq <- readRDS(physeq_path)

# Subset 100 random OTUs
set.seed(123)
selected_otus <- sample(taxa_names(physeq), 100)
physeq_100 <- prune_taxa(selected_otus, physeq)
```

---

# 3. Fit the Occupancy–Detection Model

```{r fit-model, echo=FALSE}
out <- FitModel(
  phyloseq = physeq_100,
  poisson_rhs = quote((1|OTU)+(1|Site/OTU)+(1|Sample/OTU)+(1|Replicate/OTU)+treatment*OTU),
  binomial_rhs = quote((1|OTU)+(1|Site/OTU)),
  sampletype_keep = "biologicalsample",
  abundance_threshold = 1,
  treatment_exclude = "0",
  n_iter = 50,
  burn_in = 10
)
```

---

# 4. Visualization

## 4.1 Detection Probability Caterpillar Plot

```{r plot-detect, fig.width=10, fig.height=9}
p_detect_data <- out$summary %>%
  select(OTU, Site, treatment, p_detect_mean, p_detect_lwr, p_detect_upr) %>%
  group_by(OTU) %>%
  mutate(mean_over_sites = mean(p_detect_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(mean_over_sites) %>%
  mutate(OTU = factor(OTU, levels = unique(OTU)))

ggplot(p_detect_data, aes(x = p_detect_mean, y = OTU)) +
  geom_point(color = "darkblue") +
  geom_errorbarh(aes(xmin = p_detect_lwr, xmax = p_detect_upr), height = 0.2) +
  labs(title = "Caterpillar Plot of Detection Probability by OTU",
       x = "Probability of Detection", y = "OTU") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5))
```

---

## 4.2 Occupancy Probability Caterpillar Plot

```{r plot-occupancy,fig.width=10, fig.height=9}
psi_data <- out$summary %>%
  select(OTU, Site, treatment, psi_mean, psi_lwr, psi_upr) %>%
  group_by(OTU) %>%
  mutate(mean_over_sites = mean(psi_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(mean_over_sites) %>%
  mutate(OTU = factor(OTU, levels = unique(OTU)))

ggplot(psi_data, aes(x = psi_mean, y = OTU)) +
  geom_point(color = "darkgreen") +
  geom_errorbarh(aes(xmin = psi_lwr, xmax = psi_upr), height = 0.2) +
  labs(title = "Caterpillar Plot of Occupancy Probability by OTU",
       x = "Probability of Occupancy (ψ)", y = "OTU") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 7),
        plot.title = element_text(hjust = 0.5))
```

---

## 4.3 Occupancy by Treatment

```{r plot-psi-treatment,fig.width=10, fig.height=9}
psi_treatment <- out$summary %>%
  select(OTU, treatment, psi_mean, psi_lwr, psi_upr) %>%
  group_by(OTU) %>%
  mutate(mean_overall = mean(psi_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(mean_overall) %>%
  mutate(OTU = factor(OTU, levels = unique(OTU)))

ggplot(psi_treatment, aes(x = psi_mean, y = OTU, color = treatment)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbarh(aes(xmin = psi_lwr, xmax = psi_upr), height = 0.2,
                 position = position_dodge(width = 0.5)) +
  labs(title = "Occupancy (ψ) by OTU and Treatment",
       x = "Occupancy Probability (ψ)", y = "OTU", color = "Treatment") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6),
        plot.title = element_text(hjust = 0.5))
```

---

## 4.4 Clustered Heatmap of Occupancy Probabilities

```{r heatmap-psi,fig.width=10, fig.height=9}
psi_matrix <- out$summary %>%
  select(Site, OTU, treatment, psi_mean) %>%
  group_by(Site, OTU) %>%
  summarise(psi_mean = mean(psi_mean, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = OTU, values_from = psi_mean) %>%
  column_to_rownames("Site") %>%
  as.matrix()

psi_matrix[is.na(psi_matrix)] <- 0

pheatmap(psi_matrix,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         scale = "none",
         main = "Clustered Heatmap of Occupancy Probabilities (ψ)",
         color = colorRampPalette(c("white", "blue"))(100))
```


```{r model-comparison-full, echo=FALSE}

##For example 

out1 <- FitModel(
  phyloseq = physeq_100,
  poisson_rhs = quote((1|OTU)+(1 | Site/OTU) + (1 | Sample/OTU) + (1 | Replicate/OTU) + treatment*OTU),
  binomial_rhs = quote((1 | OTU) + (1 | Site/OTU)),
  sampletype_keep = "biologicalsample",
  abundance_threshold = 1,
  treatment_exclude = "0",
  n_iter = 50,
  burn_in = 10
)

out2<- FitModel(
  phyloseq = physeq_100,
  poisson_rhs = quote((1|OTU)+(1 | Site/OTU)),
  binomial_rhs = quote((1 | OTU) + (1 | Site/OTU)),
  sampletype_keep = "biologicalsample",
  abundance_threshold = 1,
  treatment_exclude = "0",
  n_iter = 50,
  burn_in = 10
)

# Extract model metrics (AIC, BIC, NegLogLik) across multiple iterations
extract_model_metrics <- function(model_list) {
  metrics_df <- do.call(rbind, lapply(model_list, function(mod) {
    if (inherits(mod, "glmmTMB")) {
      data.frame(
        AIC = AIC(mod),
        BIC = BIC(mod),
        NegLogLik = -as.numeric(logLik(mod))
      )
    } else {
      warning("Non-glmmTMB object in list, skipping.")
      NULL
    }
  }))
  return(metrics_df)
}

# Extract metrics for each result object (after burn-in)
poisson_metrics_out1 <- extract_model_metrics(out1$poisson_models)
poisson_metrics_out2 <- extract_model_metrics(out2$poisson_models)

binomial_metrics_out1 <- extract_model_metrics(out1$binomial_models)
binomial_metrics_out2 <- extract_model_metrics(out2$binomial_models)

# Combine summary
summary_metrics <- data.frame(
  Model = c("Poisson_Out1", "Poisson_Out2", "Binomial_Out1", "Binomial_Out2"),
  AIC   = c(mean(poisson_metrics_out1$AIC, na.rm = TRUE),
            mean(poisson_metrics_out2$AIC, na.rm = TRUE),
            mean(binomial_metrics_out1$AIC, na.rm = TRUE),
            mean(binomial_metrics_out2$AIC, na.rm = TRUE)),
  BIC   = c(mean(poisson_metrics_out1$BIC, na.rm = TRUE),
            mean(poisson_metrics_out2$BIC, na.rm = TRUE),
            mean(binomial_metrics_out1$BIC, na.rm = TRUE),
            mean(binomial_metrics_out2$BIC, na.rm = TRUE)),
  NegLogLik = c(mean(poisson_metrics_out1$NegLogLik, na.rm = TRUE),
                mean(poisson_metrics_out2$NegLogLik, na.rm = TRUE),
                mean(binomial_metrics_out1$NegLogLik, na.rm = TRUE),
                mean(binomial_metrics_out2$NegLogLik, na.rm = TRUE))
)

# Display the result
print(summary_metrics)

############################ model comparison model as whole ############################

# Helper function to extract model metrics safely
extract_model_metrics <- function(model_list) {
  metrics_df <- do.call(rbind, lapply(model_list, function(mod) {
    if (inherits(mod, "glmmTMB")) {
      data.frame(
        AIC = AIC(mod),
        BIC = BIC(mod),
        NegLogLik = -as.numeric(logLik(mod))
      )
    } else {
      warning("Skipping non-glmmTMB model object.")
      NULL
    }
  }))
  return(metrics_df)
}

# Extract metrics for out1
poisson_metrics_out1 <- extract_model_metrics(out1$poisson_models)
binomial_metrics_out1 <- extract_model_metrics(out1$binomial_models)

# Extract metrics for out2
poisson_metrics_out2 <- extract_model_metrics(out2$poisson_models)
binomial_metrics_out2 <- extract_model_metrics(out2$binomial_models)

# Compute total (sum) of metrics across both models for each run
overall_metrics <- data.frame(
  Model = c("out1", "out2"),
  Total_AIC = c(
    sum(poisson_metrics_out1$AIC, na.rm = TRUE) + sum(binomial_metrics_out1$AIC, na.rm = TRUE),
    sum(poisson_metrics_out2$AIC, na.rm = TRUE) + sum(binomial_metrics_out2$AIC, na.rm = TRUE)
  ),
  Total_BIC = c(
    sum(poisson_metrics_out1$BIC, na.rm = TRUE) + sum(binomial_metrics_out1$BIC, na.rm = TRUE),
    sum(poisson_metrics_out2$BIC, na.rm = TRUE) + sum(binomial_metrics_out2$BIC, na.rm = TRUE)
  ),
  Total_NegLogLik = c(
    sum(poisson_metrics_out1$NegLogLik, na.rm = TRUE) + sum(binomial_metrics_out1$NegLogLik, na.rm = TRUE),
    sum(poisson_metrics_out2$NegLogLik, na.rm = TRUE) + sum(binomial_metrics_out2$NegLogLik, na.rm = TRUE)
  )
)

# Print the comparison summary
print(overall_metrics)

```
