% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/FitModel.R
\name{FitModel}
\alias{FitModel}
\title{Fit a Two-Part Occupancy-Abundance Model for Microbiome Data}
\usage{
FitModel(
  phyloseq,
  site_col,
  abundance_rhs,
  occupancy_rhs,
  min_species_sum = 50,
  abundance_threshold = 1,
  n_iter = 50,
  burn_in = 10,
  abundance_family = "poisson"
)
}
\arguments{
\item{phyloseq}{A `phyloseq` object containing OTU table, sample data, and taxonomy.}

\item{site_col}{Character. Name of the column in `sample_data` representing sampling sites.}

\item{abundance_rhs}{Right-hand side of the formula for abundance model (e.g., `Treatment * OTU`).}

\item{occupancy_rhs}{Right-hand side of the formula for occupancy model (e.g., `Treatment + OTU`).}

\item{min_species_sum}{Integer. Minimum total count for an OTU to be retained in analysis. Default: 50.}

\item{abundance_threshold}{Integer. Minimum count threshold to consider OTU as present. Default: 1.}

\item{n_iter}{Integer. Number of iterations for Gibbs-like sampling. Default: 50.}

\item{burn_in}{Integer. Number of iterations to discard as burn-in. Default: 10.}

\item{abundance_family}{Character. Family for abundance model. One of `"poisson"`, `"nbinom"`, `"zip"`, or `"zinb"`. Default: `"poisson"`.}
}
\value{
A list containing:
\describe{
  \item{summary}{Posterior summaries of occupancy (psi), abundance (lambda), and detection probability (p_detect)}
  \item{psi_list}{List of occupancy estimates per iteration}
  \item{lambda_list}{List of abundance estimates per iteration}
  \item{p_detect_list}{List of detection probabilities per iteration}
  \item{occupancy_models}{Fitted GLLVM occupancy models}
  \item{abundance_models}{Fitted GLMM abundance models}
  \item{reduced_data}{Processed input data}
  }
}
\description{
Implements a hierarchical Bayesian-style framework using repeated GLMM fitting
to estimate microbial occupancy (presence/absence) and abundance conditional
on presence, for OTU-level microbiome data stored in a `phyloseq` object.
}
\details{
This function decomposes species occurrence into two processes:
1. **Occupancy** (presence/absence): modeled with a binomial GLMM (`glmmTMB`).
2. **Abundance** (counts given presence): modeled with Poisson, Negative Binomial, or Zero-Inflated Poisson/NegBin.

At each iteration:
- Simulate detection given occupancy and abundance.
- Fit occupancy and abundance models.
- Update simulated presence (`z_sim`) using current parameter estimates.

Posterior summaries are computed using inverse-variance weighting across iterations (after burn-in).
}
\section{Model Features}{

- Supports nested or interaction terms with `OTU` (e.g., `Treatment * OTU`, `Group / OTU`).
- Automatically detects treatment or nested variables used in the formula.
- Applies reweighting based on prediction uncertainty to generate robust estimates.
- Automatically relevels `OTU` to the most abundant taxon for model stability.
}

\examples{
\dontrun{
# Example usage of FitModel with a phyloseq object named `physeq_one`

out <- FitModel(
 phyloseq = ps_obj,
site_col = "Site",
abundance_rhs = Treatment * OTU,
occupancy_rhs = Treatment + OTU,
abundance_family = "nbinom",
n_iter = 100,
burn_in = 20
)
# Check the output summary
head(out$summary)

}

}
